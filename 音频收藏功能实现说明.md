# 音频收藏功能实现说明

## 功能概述

已完成的音频收藏功能包括以下特性：

### 1. 音频收藏管理
- ✅ 创建多个收藏文件夹
- ✅ 将音频收藏到不同的文件夹内
- ✅ 为每个收藏的音频添加备注
- ✅ 查看收藏文件夹内的所有音频
- ✅ 点击收藏的音频可以直接跳转播放
- ✅ 删除收藏文件夹和收藏的音频

### 2. 标记表查看功能
- ✅ 可以查看所有收藏音频的标记表（共用视频标记查看页面）
- ✅ 按文件夹分组显示音频及其标记
- ✅ 点击某个音频的某个标记，可以跳转到该音频并从标记位置开始播放
- ✅ 显示每个标记的时间点、标题和内容

### 3. 音频播放器集成
- ✅ 在音频播放器页面添加"更多"按钮（三个点）
- ✅ 点击按钮后可以看到：
  - 查看音频收藏
  - 查看所有标记
  - 添加到收藏（选择文件夹）
  - 创建新文件夹

## 与视频收藏的区别

- **独立的页面**：音频收藏有自己独立的页面（`/audio-favorites`），不与视频收藏共用
- **独立的数据表**：使用独立的数据库表（`audio_favorite_folders` 和 `audio_favorites`）
- **独立的API**：使用独立的API路由（`/api/audio_favorites/`）
- **UI显示**：使用音频图标和音频相关的文本

## 技术实现

### 后端 (Go)

#### 数据模型
1. **AudioFavoriteFolder** - 收藏文件夹
   - ID, UserId, Name, Description, Order
   - 支持排序和描述

2. **AudioFavorite** - 收藏的音频
   - ID, UserId, FolderId, StorageId, OriginalPath, FileName, Note, Fingerprint
   - 通过Fingerprint关联媒体标记

#### API 路由
```
/api/audio_favorites/
  ├─ folder/
  │  ├─ list      (GET)  - 列出所有文件夹
  │  ├─ get       (GET)  - 获取单个文件夹
  │  ├─ create    (POST) - 创建文件夹
  │  ├─ update    (POST) - 更新文件夹
  │  └─ delete    (POST) - 删除文件夹
  ├─ list         (GET)  - 列出音频（可按文件夹筛选）
  ├─ create       (POST) - 添加音频到收藏
  ├─ update       (POST) - 更新音频备注
  ├─ delete       (POST) - 从收藏移除音频
  └─ all_marks    (GET)  - 获取所有收藏音频的标记
```

#### 数据库操作
- 文件位置: `OpenList-main/internal/db/audio_favorites.go`
- 包含完整的CRUD操作
- 自动级联删除（删除文件夹时删除其中的音频）
- 防止重复收藏

### 前端 (TypeScript/SolidJS)

#### 页面组件

1. **音频收藏页面** (`/audio-favorites`)
   - 左侧：收藏文件夹列表
   - 右侧：选中文件夹内的音频列表
   - 支持创建、删除文件夹
   - 支持删除收藏的音频
   - 点击音频可跳转播放

2. **标记表查看页面** (`/media-marks`)
   - 与视频收藏共用此页面
   - 按文件夹分组显示
   - 折叠面板展示每个音频的标记
   - 显示标记时间、标题、内容
   - 点击标记可跳转到音频并定位到该时间点

3. **音频菜单按钮组件**
   - 集成在音频播放器页面
   - 提供"更多"按钮
   - 弹出对话框显示操作选项
   - 支持添加到收藏、查看收藏、查看所有标记

#### 类型定义
- `AudioFavoriteFolder` - 收藏文件夹类型
- `AudioFavorite` - 收藏音频类型  
- `AudioWithMarks` - 带标记的音频类型

#### API 工具函数
- 文件位置: `OpenList-Frontend-main/src/utils/audio-favorites.ts`
- 包含所有API调用的封装函数

## 使用方法

### 收藏音频
1. 打开音频播放器
2. 点击"⋮ 更多"按钮
3. 选择"添加到音频收藏"
4. 选择或创建收藏文件夹
5. 可选：添加备注
6. 点击"添加到收藏"

### 查看收藏
1. 点击"⋮ 更多"按钮
2. 选择"查看音频收藏"
3. 或直接访问 `/audio-favorites`

### 查看所有标记
1. 点击"⋮ 更多"按钮
2. 选择"查看所有标记"
3. 或直接访问 `/media-marks`
4. 展开音频查看其标记列表
5. 点击标记可跳转播放

## 文件清单

### 后端新增文件
- `OpenList-main/internal/model/audio_favorite.go` - 数据模型
- `OpenList-main/internal/db/audio_favorites.go` - 数据库操作
- `OpenList-main/server/handles/audio_favorites.go` - API处理器

### 后端修改文件
- `OpenList-main/server/router.go` - 添加路由（添加了 `_audioFavorites` 函数）
- `OpenList-main/internal/db/db.go` - 数据库初始化（添加了音频收藏表）

### 前端新增文件
- `OpenList-Frontend-main/src/types/audio-favorite.ts` - 类型定义
- `OpenList-Frontend-main/src/utils/audio-favorites.ts` - API工具
- `OpenList-Frontend-main/src/pages/audio-favorites/index.tsx` - 收藏页面
- `OpenList-Frontend-main/src/components/AudioMenuButton.tsx` - 菜单按钮组件

### 前端修改文件
- `OpenList-Frontend-main/src/app/App.tsx` - 路由配置（添加音频收藏路由）
- `OpenList-Frontend-main/src/types/index.ts` - 类型导出
- `OpenList-Frontend-main/src/components/index.ts` - 组件导出
- `OpenList-Frontend-main/src/pages/home/previews/audio.tsx` - 集成菜单按钮
- `OpenList-Frontend-main/src/lang/zh-cn/home.json` - 添加音频收藏相关文本
- `OpenList-Frontend-main/src/lang/en/home.json` - 更新英文文本（视频收藏标题）

### 语言文件修改
- 将"我的收藏"改为"我的视频收藏"
- 添加了完整的音频收藏相关翻译文本

## 注意事项

1. **权限控制**：所有功能需要用户登录，游客用户无法使用
2. **数据隔离**：每个用户只能看到和操作自己的收藏和标记
3. **防重复**：同一音频不能重复添加到同一个文件夹
4. **级联删除**：删除文件夹会同时删除其中的所有音频收藏
5. **独立实现**：音频收藏与视频收藏完全独立，不共用页面和数据

## 技术细节

### 前端实现
1. **buildMediaFingerprint**：使用与视频收藏相同的指纹生成方法
2. **异步处理**：所有API调用都是异步的，返回 Promise
3. **错误处理**：完善的错误提示和异常处理

### 后端实现
- `storage_id` 在后端自动从路径中获取，前端无需传递
- 使用 GORM 进行数据库操作
- 完善的权限验证和用户隔离

## 后续优化建议

1. 添加收藏夹排序功能
2. 支持音频在文件夹间移动
3. 支持批量操作
4. 添加搜索功能
5. 支持导出/导入收藏
6. 为文件夹添加封面图片
7. 支持播放列表功能

## 测试建议

1. 创建多个音频收藏文件夹
2. 收藏不同的音频到不同文件夹
3. 为音频添加标记
4. 测试标记跳转功能
5. 测试删除操作
6. 测试重复收藏检测
7. 验证音频收藏与视频收藏互不影响

