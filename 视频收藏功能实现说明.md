# 视频收藏功能实现说明

## 功能概述

已完成的视频收藏功能包括以下特性：

### 1. 视频收藏管理
- ✅ 创建多个收藏文件夹
- ✅ 将视频收藏到不同的文件夹内
- ✅ 为每个收藏的视频添加备注
- ✅ 查看收藏文件夹内的所有视频
- ✅ 点击收藏的视频可以直接跳转播放
- ✅ 删除收藏文件夹和收藏的视频

### 2. 标记表查看功能
- ✅ 有专门的页面查看**所有已标记视频**的标记表（不限于收藏视频）
- ✅ 按文件夹分组显示视频及其标记（已收藏的视频显示在对应文件夹下，未收藏的显示在"未收藏"分组）
- ✅ 点击某个视频的某个标记，可以跳转到该视频并从标记位置开始播放
- ✅ 显示每个标记的时间点、标题和内容

### 3. 视频播放器集成
- ✅ 在视频播放器页面添加"更多"按钮（三个点）
- ✅ 点击按钮后可以看到：
  - 查看收藏
  - 查看所有标记
  - 添加到收藏（选择文件夹）
  - 创建新文件夹

## 技术实现

### 后端 (Go)

#### 数据模型
1. **VideoFavoriteFolder** - 收藏文件夹
   - ID, UserId, Name, Description, Order
   - 支持排序和描述

2. **VideoFavorite** - 收藏的视频
   - ID, UserId, FolderId, StorageId, OriginalPath, FileName, Note, Fingerprint
   - 通过Fingerprint关联媒体标记

#### API 路由
```
/api/video_favorites/
  ├─ folder/
  │  ├─ list      (GET)  - 列出所有文件夹
  │  ├─ get       (GET)  - 获取单个文件夹
  │  ├─ create    (POST) - 创建文件夹
  │  ├─ update    (POST) - 更新文件夹
  │  └─ delete    (POST) - 删除文件夹
  ├─ list         (GET)  - 列出视频（可按文件夹筛选）
  ├─ create       (POST) - 添加视频到收藏
  ├─ update       (POST) - 更新视频备注
  ├─ delete       (POST) - 从收藏移除视频
  └─ all_marks    (GET)  - 获取所有收藏视频的标记
```

#### 数据库操作
- 文件位置: `OpenList-main/internal/db/video_favorites.go`
- 包含完整的CRUD操作
- 自动级联删除（删除文件夹时删除其中的视频）
- 防止重复收藏

### 前端 (TypeScript/SolidJS)

#### 页面组件

1. **视频收藏页面** (`/video-favorites`)
   - 左侧：收藏文件夹列表
   - 右侧：选中文件夹内的视频列表
   - 支持创建、删除文件夹
   - 支持删除收藏的视频
   - 点击视频可跳转播放

2. **标记表查看页面** (`/media-marks`)
   - 按文件夹分组显示
   - 折叠面板展示每个视频的标记
   - 显示标记时间、标题、内容
   - 点击标记可跳转到视频并定位到该时间点

3. **视频菜单按钮组件**
   - 集成在视频播放器页面
   - 提供"更多"按钮
   - 弹出对话框显示操作选项
   - 支持添加到收藏、查看收藏、查看所有标记

#### 类型定义
- `VideoFavoriteFolder` - 收藏文件夹类型
- `VideoFavorite` - 收藏视频类型  
- `VideoWithMarks` - 带标记的视频类型

#### API 工具函数
- 文件位置: `OpenList-Frontend-main/src/utils/video-favorites.ts`
- 包含所有API调用的封装函数

## 使用方法

### 收藏视频
1. 打开视频播放器
2. 点击右上角的"⋮ 更多"按钮
3. 选择"添加到收藏"
4. 选择或创建收藏文件夹
5. 可选：添加备注
6. 点击"添加到收藏"

### 查看收藏
1. 点击"⋮ 更多"按钮
2. 选择"查看收藏"
3. 或直接访问 `/video-favorites`

### 查看所有标记
1. 点击"⋮ 更多"按钮
2. 选择"查看所有标记"
3. 或直接访问 `/media-marks`
4. 展开视频查看其标记列表
5. 点击标记可跳转播放

## 文件清单

### 后端新增文件
- `OpenList-main/internal/model/video_favorite.go` - 数据模型
- `OpenList-main/internal/db/video_favorites.go` - 数据库操作
- `OpenList-main/server/handles/video_favorites.go` - API处理器

### 后端修改文件
- `OpenList-main/server/router.go` - 添加路由
- `OpenList-main/internal/db/db.go` - 数据库初始化

### 前端新增文件
- `OpenList-Frontend-main/src/types/video-favorite.ts` - 类型定义
- `OpenList-Frontend-main/src/utils/video-favorites.ts` - API工具
- `OpenList-Frontend-main/src/pages/video-favorites/index.tsx` - 收藏页面
- `OpenList-Frontend-main/src/pages/media-marks/index.tsx` - 标记表页面
- `OpenList-Frontend-main/src/components/VideoMenuButton.tsx` - 菜单按钮组件

### 前端修改文件
- `OpenList-Frontend-main/src/app/App.tsx` - 路由配置
- `OpenList-Frontend-main/src/types/index.ts` - 类型导出
- `OpenList-Frontend-main/src/components/index.ts` - 组件导出
- `OpenList-Frontend-main/src/utils/media-marks.ts` - 添加fingerprint工具
- `OpenList-Frontend-main/src/pages/home/previews/video.tsx` - 集成菜单按钮

## 注意事项

1. **权限控制**：所有功能需要用户登录，游客用户无法使用
2. **数据隔离**：每个用户只能看到和操作自己的收藏和标记
3. **防重复**：同一视频不能重复添加到同一个文件夹
4. **级联删除**：删除文件夹会同时删除其中的所有视频收藏

## 技术细节

### 前端导入修复
1. **hash工具**：使用 `hash-wasm` 的 `createMD5` 替代不存在的 `hash` 导出
2. **request工具**：使用正确的 `r` 导出替代 `request`
3. **异步处理**：`buildMediaFingerprint` 改为异步函数，返回 Promise

### 后端自动填充
- `storage_id` 在后端自动从路径中获取，前端无需传递

## 后续优化建议

1. 添加收藏夹排序功能
2. 支持视频在文件夹间移动
3. 支持批量操作
4. 添加搜索功能
5. 支持导出/导入收藏
6. 为文件夹添加封面图片

## 测试建议

1. 创建多个收藏文件夹
2. 收藏不同的视频到不同文件夹
3. 为视频添加标记
4. 测试标记跳转功能
5. 测试删除操作
6. 测试重复收藏检测

## 已知问题修复记录

### 2024年编译错误修复
✅ 修复了 `hash` 导入错误 - 改用 `hash-wasm` 的 `createMD5`
✅ 修复了 `request` 导入错误 - 改用 `r` 从 `request.ts`
✅ 修复了 `buildMediaFingerprint` 异步问题
✅ 修复了 `storage_id` 获取问题 - 后端自动从路径获取

### 2025年功能改进

#### 第一次改进：显示所有标记
✅ **标记表页面改进** - 现在显示所有已标记的视频，不限于已收藏的视频
  - 添加了 `ListAllMediaMarksByUser` 数据库函数
  - 修改了 `ListAllVideoMarks` API，获取所有标记并按视频分组
  - 未收藏的视频显示在"未收藏"分组下

#### 第二次改进：新UI布局和音频支持
✅ **全新的标记管理界面**
  - 左侧面板：
    - 顶部：视频/音频切换按钮
    - 下方：文件夹列表（显示每个文件夹内的媒体数量）
  - 右侧面板：
    - 显示选中文件夹内的所有媒体及其标记
    - 点击标记可跳转播放
  - 同时支持视频和音频标记管理
  - 更新了 `ListAllAudioMarks` API，使其与视频逻辑一致

#### 第三次改进：路径分组和跳转修复
✅ **未收藏文件按实际目录分组**
  - 已收藏的文件：按收藏文件夹名称分组
  - 未收藏的文件：按实际目录路径分组（如 `\ASMR\南晚姐姐\提督视频`）
  - 修复了文件路径问题，确保能正确跳转
  
✅ **修复路径存储和跳转问题**
  - 后端修改：
    - `media_marks.go`: 创建标记时保存完整路径（包含 Storage MountPath）
    - `video_favorites.go` 和 `audio_favorites.go`: API返回时为旧标记补全路径
  - 前端修改：
    - 确保跳转时使用绝对路径
    - 支持按目录路径分组显示

#### 第四次改进：文件类型过滤
✅ **修复视频/音频标签过滤问题**
  - 问题：点击"视频"按钮时，音频文件也显示在列表中
  - 原因：`MediaMark` 表没有文件类型字段，两个API都返回所有标记
  - 解决方案：
    - `video_favorites.go`: 使用 `utils.GetFileType()` 根据文件扩展名过滤，只返回视频文件
    - `audio_favorites.go`: 只返回音频文件
    - 支持的视频格式：mp4, mkv, flv, avi, wmv, ts, rmvb, webm 等
    - 支持的音频格式：mp3, flac, aac, wav, ogg, m4a, wma, alac 等

